<!DOCTYPE html>
<html>
<head>
    <title>CCTV By TumMeng</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }
        #map {
            height: 700px;
            width: 100%;
            border: 2px solid #333;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .custom-label {
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 5px;
            border: 1px solid #0078A8;
            border-radius: 5px;
            white-space: nowrap;
            font-size: 14px;
            color: #333;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .custom-marker {
            border-radius: 25%;
            background: #0078A8;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .warning {
            color: red;
            padding: 10px;
            font-size: 14px;
        }
        input, button {
            margin: 5px;
            padding: 8px;
            font-size: 14px;
        }
        button {
            background-color: #0078A8;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #005f80;
        }
    </style>
</head>
<body>
    <h1>CCTV By TumMeng</h1>
    <p>ดูกล้อง CCTV และตำแหน่งของคุณบนแผนที่</p>
    <p class="warning">กรุณาอนุญาตการเข้าถึงตำแหน่งเมื่อเบราว์เซอร์ถามเพื่อแสดงตำแหน่งของคุณ</p>
    <div>
        <label>ละติจูด: <input type="number" id="lat" step="any" placeholder="เช่น 12.663364519497001"></label>
        <label>ลองจิจูด: <input type="number" id="lng" step="any" placeholder="เช่น 101.50340730262141"></label>
        <button onclick="setManualLocation()">แสดงตำแหน่ง</button>
    </div>
    <div id="map"></div>
    <script>
        var map = null;
        var userMarker = null;

        // เริ่มต้นแผนที่
        window.onload = function() {
            console.log("เริ่มสร้างแผนที่");
            map = L.map('map').setView([13.322851, 100.973910], 8);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18
            }).addTo(map);

            // สร้างไอคอน CCTV
            console.log("สร้างไอคอน CCTV");
            var customIcon = L.divIcon({
                className: 'custom-marker',
                html: '<div style="width: 20px; height: 10px;"></div>',
                iconSize: [14, 14],
                iconAnchor: [12, 12]
            });

            // เพิ่ม markers CCTV
            console.log("เพิ่ม markers CCTV");
            var locations = [
                { coords: [12.80377, 101.1458], url: "https://streaming2.highwaytraffic.go.th/P16/PER_16_016_OUT.stream/playlist.m3u8", label: "มะขามคู่" },
                { coords: [13.787847, 100.327043], url: "https://streaming1.highwaytraffic.go.th/Interchange/ITC-017.stream/playlist.m3u8", label: "ศาลายา" }
            ];
            locations.forEach(function(loc) {
                var marker = L.marker(loc.coords, { icon: customIcon }).addTo(map);
                var label = L.marker(loc.coords, {
                    icon: L.divIcon({
                        className: 'custom-label',
                        html: loc.label,
                        iconSize: [100, 30],
                        iconAnchor: [50, -25]
                    })
                }).addTo(map);
                marker.on('click', function() {
                    console.log("คลิก marker: " + loc.label);
                    window.open(loc.url, '_blank', 'width=600,height=400,toolbar=no,menubar=no,scrollbars=yes,resizable=yes');
                });
            });

            // เรียก Geolocation อัตโนมัติ
            console.log("เริ่มเรียก Geolocation อัตโนมัติ");
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        var lat = position.coords.latitude;
                        var lng = position.coords.longitude;
                        console.log("ตำแหน่งผู้ใช้: ", lat, lng);
                        updateUserLocation(lat, lng);
                    },
                    function(error) {
                        console.error("ข้อผิดพลาด geolocation: ", error.message);
                        alert("ไม่สามารถดึงตำแหน่งของคุณได้: " + error.message + "\nกรุณาป้อนพิกัดด้วยตนเอง");
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                console.log("Geolocation ไม่รองรับในเบราว์เซอร์");
                alert("เบราว์เซอร์ของคุณไม่รองรับการระบุตำแหน่ง กรุณาป้อนพิกัดด้วยตนเอง");
            }

            // ดึงพิกัดจาก URL (กรณีทดสอบ)
            var urlParams = new URLSearchParams(window.location.search);
            var lat = parseFloat(urlParams.get('lat'));
            var lng = parseFloat(urlParams.get('lng'));
            if (!isNaN(lat) && !isNaN(lng)) {
                console.log("พิกัดจาก URL: ", lat, lng);
                updateUserLocation(lat, lng);
            }
        };

        // ไอคอนรถ
        var carIcon = L.icon({
            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
        });

        // อัปเดตตำแหน่งผู้ใช้
        function updateUserLocation(lat, lng) {
            console.log("อัปเดตตำแหน่ง: ", lat, lng);
            if (userMarker) {
                userMarker.setLatLng([lat, lng]);
            } else {
                userMarker = L.marker([lat, lng], { icon: carIcon }).addTo(map)
                    .bindPopup("คุณอยู่ที่นี่!").openPopup();
            }
            map.setView([lat, lng], 15);
            alert("แสดงตำแหน่งของคุณแล้ว!");
        }

        // ป้อนพิกัดด้วยตนเอง
        function setManualLocation() {
            var lat = parseFloat(document.getElementById('lat').value);
            var lng = parseFloat(document.getElementById('lng').value);
            if (isNaN(lat) || isNaN(lng)) {
                alert("กรุณาป้อนพิกัดที่ถูกต้อง");
                return;
            }
            console.log("ป้อนพิกัดด้วยตนเอง: ", lat, lng);
            updateUserLocation(lat, lng);
        }
    </script>
</body>
</html>
